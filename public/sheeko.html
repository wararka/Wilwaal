<!DOCTYPE html>
<html lang="so">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Sheeko - Loading...</title>
    <link rel="stylesheet" href="sheeko.css">
</head>
<body>
    <header>
        <a href="users-list.html" class="back-button">â¬…ï¸</a>
        <div class="chat-info">
            <img id="partnerImage" src="/profiles/default.png" alt="Partner Profile">
            <h3 id="partnerUsername">Wada Sheekaysiga: ...</h3>
        </div>
        <div id="myUserInfo">
            <span id="myUsernameDisplay" style="font-weight: bold;">...</span>
            <img id="myProfileImage" src="/profiles/default.png" alt="My Profile">
        </div>
    </header>

    <div id="messagesContainer">
        <p style="text-align: center; color: #888;">Fadlan sug... Waxaan soo dejinayaa taariikhda sheekada.</p>
    </div>

    <div id="inputArea">
        <form id="chatForm">
            <input type="file" id="mediaFile" name="mediaFile" accept="image/*,video/*,audio/*" style="display:none;">
            <button type="button" id="attachButton" aria-label="Attach file">ğŸ“</button>
            <textarea id="messageInput" placeholder="Ku qor halkan..." rows="1"></textarea>
            <button type="submit" id="sendButton">Dir</button>
        </form>
        <div id="fileInfo" class="file-info"></div>
    </div>

    <script>
        // Xogta Muhiimka ah
        let partnerId, partnerName;
        let myUserId, myUsername, myProfileImage;
        let lastMessageId = null; 
        let pollingInterval = null;
        const urlParams = new URLSearchParams(window.location.search);
        
        // Ogaysiiska
        const audio = new Audio('/notification.mp3'); 

        // Mobile detection
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

        document.addEventListener('DOMContentLoaded', () => {
            partnerId = parseInt(urlParams.get('partnerId')); 
            partnerName = urlParams.get('partnerName');
            
            if (!partnerId || isNaN(partnerId)) {
                document.getElementById('messagesContainer').innerHTML = '<p style="color: red; text-align: center;">Khalad: Lama cayimin partner-ka sheekada.</p>';
                return;
            }

            // Add mobile class to body for CSS targeting
            if (isMobile) {
                document.body.classList.add('mobile-device');
            }

            // A. Dejinta Xogta Partner-ka
            document.getElementById('pageTitle').textContent = `Sheeko - ${partnerName}`;
            document.getElementById('partnerUsername').textContent = `Wada: ${partnerName}`;
            
            // B. Soo Dejinta Xogta User-kaaga
            fetchMyInfoAndStartChat();
            
            // C. Ku Xirida Foomka
            document.getElementById('chatForm').addEventListener('submit', sendMessage);
            document.getElementById('mediaFile').addEventListener('change', updateFileInfo);
            document.getElementById('attachButton').addEventListener('click', () => {
                document.getElementById('mediaFile').click();
            });

            // D. Weydiinta Ogolaanshaha Ogaysiiska
            requestNotificationPermission();

            // E. Mobile-specific optimizations
            if (isMobile) {
                optimizeForMobile();
            }
        });

        // Mobile optimizations
        function optimizeForMobile() {
            // Prevent zoom on input focus (iOS)
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('focus', function() {
                setTimeout(() => {
                    this.style.fontSize = '16px';
                }, 100);
            });

            // Better touch handling
            document.addEventListener('touchstart', function() {}, {passive: true});

            // Adjust viewport height for mobile browsers
            function setVH() {
                let vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            }
            setVH();
            window.addEventListener('resize', setVH);
            window.addEventListener('orientationchange', setVH);
        }
        
        // =========================================================
        // 1. Soo Dejinta Xogta User-kaaga iyo Bilowga Polling
        // =========================================================
        function fetchMyInfoAndStartChat() {
            fetch('/api/user-info')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        myUserId = data.user.id;
                        myUsername = data.user.username;
                        myProfileImage = data.user.profileImage || '/profiles/default.png';

                        document.getElementById('myUsernameDisplay').textContent = myUsername;
                        document.getElementById('myProfileImage').src = myProfileImage;
                        
                        fetchPartnerInfo(partnerId);

                        // Bilowga Polling-ka
                        fetchMessages(true); 
                        
                        // Stop any existing interval before starting new one
                        if (pollingInterval) {
                            clearInterval(pollingInterval);
                        }
                        pollingInterval = setInterval(() => fetchMessages(false), 3000);
                        
                        // Ku dar Maaraynta Enter Key
                        handleEnterKey(); 

                    } else {
                        alert('Khalad: Lama soo dejin karo xogta user-kaaga.');
                    }
                })
                .catch(error => {
                    console.error('Khalad ku yimid fetchMyInfo:', error);
                    alert('Khalad: Qalad ka dhacay markii la soo dejinin xogta user-ka.');
                });
        }

        // =========================================================
        // 2. Soo Dejinta Sawirka Partner-ka
        // =========================================================
        function fetchPartnerInfo(id) {
            fetch(`/api/profile/user-data/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        if (data.user.profileImage) {
                            document.getElementById('partnerImage').src = data.user.profileImage;
                        }
                        // Update partner name if available from API
                        if (data.user.username && data.user.username !== partnerName) {
                            partnerName = data.user.username;
                            document.getElementById('partnerUsername').textContent = `Wada: ${partnerName}`;
                            document.getElementById('pageTitle').textContent = `Sheeko - ${partnerName}`;
                        }
                    }
                })
                .catch(error => console.error('Lama helin sawirka partner-ka:', error));
        }
        
        // =========================================================
        // 3. Muujinta Macluumaadka File-ka
        // =========================================================
        function updateFileInfo(e) {
            const file = e.target.files[0];
            const infoElement = document.getElementById('fileInfo');
            if (file) {
                const fileSizeMB = (file.size / 1024 / 1024).toFixed(2);
                infoElement.textContent = `File: ${file.name} (${fileSizeMB} MB)`;
                infoElement.style.color = 'green';
                
                // Auto-send if it's a file on mobile (optional)
                if (isMobile && !document.getElementById('messageInput').value.trim()) {
                    setTimeout(() => sendMessage(), 500);
                }
            } else {
                infoElement.textContent = '';
            }
        }
        
        // =========================================================
        // 4. Shaqada Fariin Dirista
        // =========================================================
        function sendMessage(e) {
            if (e) e.preventDefault();

            const messageInput = document.getElementById('messageInput');
            const mediaFile = document.getElementById('mediaFile').files[0];
            const messageText = messageInput.value.trim();

            if (!messageText && !mediaFile) {
                return;
            }

            const formData = new FormData();
            formData.append('partnerId', partnerId);
            if (messageText) {
                formData.append('messageText', messageText);
            }
            if (mediaFile) {
                formData.append('chatMedia', mediaFile);
            }
            
            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.textContent = 'Sug...';
            
            fetch('/api/chat/send-message', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                sendButton.disabled = false;
                sendButton.textContent = 'Dir';
                
                if (data.success) {
                    messageInput.value = ''; 
                    document.getElementById('mediaFile').value = ''; 
                    document.getElementById('fileInfo').textContent = '';
                    
                    // Reset textarea height
                    messageInput.style.height = 'auto';
                    
                    addMessageToContainer(data.message); 
                    lastMessageId = data.message.id; 
                    scrollToBottom();
                } else {
                    alert('Khalad: Lama dirin fariinta. ' + (data.message || ''));
                }
            })
            .catch(error => {
                console.error('Khalad ku yimid dirista fariinta:', error);
                sendButton.disabled = false;
                sendButton.textContent = 'Dir';
                alert('Khalad: Lama gaarin server-ka.');
            });
        }

        // =========================================================
        // 5. Soo Dejinta Fariimaha (Polling)
        // =========================================================
        function fetchMessages(isInitialLoad) {
            const url = isInitialLoad ? 
                        `/api/chat/history/${partnerId}` : 
                        `/api/chat/updates/${partnerId}?lastId=${lastMessageId || ''}`;

            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const messagesContainer = document.getElementById('messagesContainer');
                        
                        let isNewMessage = false;
                        if (!isInitialLoad && lastMessageId && data.messages.length > 0) {
                            const lastMsg = data.messages[data.messages.length - 1];
                            if (lastMsg.id !== lastMessageId && lastMsg.senderId !== myUserId) {
                                isNewMessage = true;
                            }
                        }

                        if (isInitialLoad || messagesContainer.innerHTML.includes("Fadlan sug...") || messagesContainer.innerHTML.includes("Weli ma jiro")) {
                            messagesContainer.innerHTML = ''; 
                        }

                        if (data.messages.length > 0) {
                            data.messages.forEach(msg => {
                                if (!document.getElementById(`msg-${msg.id}`)) {
                                    addMessageToContainer(msg);
                                }
                            });
                            
                            lastMessageId = data.messages[data.messages.length - 1].id;
                            
                            if (isInitialLoad) {
                                scrollToBottom();
                            } else if (isNewMessage) {
                                notifyUser(data.messages.length); 
                                scrollToBottom();
                            }
                        } else if (isInitialLoad) {
                            messagesContainer.innerHTML = '<p style="text-align: center; color: #888;">Weli ma jiro wax sheeko ah. Bilow Sheekada!</p>';
                        }

                    } else {
                        console.error('API error:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Khalad ku yimid soo dejinta fariimaha:', error);
                });
        }

        // =========================================================
        // 6. Dhismaha Fariin kasta oo lagu daro Container-ka
        // =========================================================
        function addMessageToContainer(message) {
            const container = document.getElementById('messagesContainer');
            const isMyMessage = message.senderId === myUserId;
            
            const senderImage = isMyMessage ? 
                                myProfileImage : 
                                (document.getElementById('partnerImage').src || '/profiles/default.png');

            const senderUsername = isMyMessage ? myUsername : partnerName;
            
            const div = document.createElement('div');
            div.className = `message-box ${isMyMessage ? 'my-message' : 'partner-message'}`;
            div.id = `msg-${message.id}`;

            const time = new Date(message.timestamp).toLocaleTimeString('so-SO', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            let mediaContent = '';
            if (message.mediaPath) {
                const mediaUrl = message.mediaPath;
                const mediaType = message.mediaType || 'image';
                
                if (mediaType === 'image') {
                    mediaContent = `<img src="${mediaUrl}" alt="Sawir la soo diray" class="message-media" loading="lazy" onclick="openMedia('${mediaUrl}')">`;
                } else if (mediaType === 'video') {
                    mediaContent = `<video controls src="${mediaUrl}" class="message-media" onclick="openMedia('${mediaUrl}')"></video>`;
                } else if (mediaType === 'audio') {
                    mediaContent = `<audio controls src="${mediaUrl}" class="message-media"></audio>`;
                } else {
                    mediaContent = `<a href="${mediaUrl}" target="_blank" class="message-media">File: ${message.mediaPath.split('/').pop()}</a>`;
                }
            }
            
            const messageTextContent = message.text ? 
                `<p class="message-text">${escapeHtml(message.text)}</p>` : '';

            // Mobile: hide sender name to save space
            const showSender = !isMobile;
            
            div.innerHTML = `
                <img src="${senderImage}" alt="${senderUsername}" class="user-message-image" onerror="this.src='/profiles/default.png'">
                <div class="message-content">
                    <div class="message-header" style="${!showSender ? 'display: none;' : ''}">
                        <span class="message-sender">${escapeHtml(senderUsername)}</span>
                        <span>${time}</span>
                    </div>
                    ${!showSender ? `<div class="message-time-mobile">${time}</div>` : ''}
                    ${messageTextContent}
                    ${mediaContent}
                </div>
            `;
            container.appendChild(div);
        }

        // Function to open media in full screen (mobile)
        function openMedia(url) {
            if (isMobile) {
                window.open(url, '_blank');
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // =========================================================
        // 7. Hoosta u deg
        // =========================================================
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            setTimeout(() => {
                container.scrollTop = container.scrollHeight;
            }, 100);
        }

        // =========================================================
        // 8. Ogaysiiska Browser-ka
        // =========================================================
        
        function requestNotificationPermission() {
            if ("Notification" in window) {
                if (Notification.permission !== "granted" && Notification.permission !== "denied") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            console.log("Ogaysiiska la ogolaaday.");
                        }
                    });
                }
            }
        }

        function notifyUser(messageCount) {
            // Only notify if window is not focused
            if (!document.hasFocus()) {
                if (Notification.permission === "granted") {
                    const options = {
                        body: `Waxaa laguu soo diray ${messageCount} fariimo cusub. Guji si aad u aragto.`,
                        icon: document.getElementById('partnerImage').src || '/profiles/default.png'
                    };
                    const n = new Notification(`Sheeko Cusub ka timid ${partnerName}`, options);
                    
                    n.onclick = (e) => {
                        e.preventDefault();
                        window.focus();
                        n.close();
                    };
                    
                    setTimeout(() => n.close(), 5000);
                } 
                
                // Play sound notification
                audio.play().catch(e => console.log('Codka lama ciyaarin si otomaatig ah.'));
            }
        }

        // =========================================================
        // 9. Maaraynta Furayaasha (Enter Key)
        // =========================================================
        function handleEnterKey() {
            const messageInput = document.getElementById('messageInput');
            
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    if (e.shiftKey) {
                        // Allow new line with Shift+Enter
                        return; 
                    } else {
                        // Send message with Enter
                        e.preventDefault(); 
                        
                        const messageText = messageInput.value.trim();
                        const mediaFile = document.getElementById('mediaFile').files[0];
                        
                        if (messageText || mediaFile) {
                            sendMessage(e); 
                        }
                    }
                }
            });

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                const newHeight = Math.min(this.scrollHeight, 120); // Max height 120px
                this.style.height = newHeight + 'px';
            });
        }

        // Clean up when leaving page
        window.addEventListener('beforeunload', () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }
        });

        // Handle mobile back button
        window.addEventListener('popstate', function(event) {
            if (isMobile) {
                window.location.href = 'users-list.html';
            }
        });






// =========================================================
//           READ RECEIPTS SYSTEM - CLIENT SIDE (SAXDA)
// =========================================================

let readStatus = {};
let readReceiptsInterval = null;

// ğŸ†• Function: Mark messages as read - SAXDA
async function markMessagesAsRead() {
    try {
        const response = await fetch(`/api/chat/mark-read/${partnerId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.updated) {
                // Refresh read status after marking as read
                fetchReadStatus();
            }
        }
    } catch (error) {
        console.error('Khalad mark-read:', error);
    }
}

// ğŸ†• Function: Fetch read status for my messages - SAXDA
async function fetchReadStatus() {
    try {
        const response = await fetch(`/api/chat/read-status/${partnerId}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                readStatus = data.readStatus;
                updateReadReceiptsUI();
            }
        }
    } catch (error) {
        console.error('Khalad read-status:', error);
    }
}

// ğŸ†• Function: Update read receipts in UI - SAXDA
function updateReadReceiptsUI() {
    // Update existing messages
    document.querySelectorAll('.message-box.my-message').forEach(messageBox => {
        const messageId = messageBox.id.replace('msg-', '');
        const status = readStatus[messageId];
        
        if (status) {
            let receiptElement = messageBox.querySelector('.read-receipt');
            
            if (!receiptElement) {
                receiptElement = document.createElement('div');
                receiptElement.className = 'read-receipt';
                messageBox.querySelector('.message-content').appendChild(receiptElement);
            }
            
            if (status.read) {
                receiptElement.innerHTML = `
                    <span class="read-text">ğŸŸ¢ La Aqriyay</span>
                    ${status.readAt ? `
                        <span class="read-time">
                            ${new Date(status.readAt).toLocaleTimeString('so-SO', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            })}
                        </span>
                    ` : ''}
                `;
                receiptElement.classList.add('read');
            } else {
                receiptElement.innerHTML = '<span class="read-text">âš« Wali lama Aqrin</span>';
                receiptElement.classList.remove('read');
            }
        }
    });
}

// ğŸ†• Function: Check if user is viewing the chat - SAXDA
function isChatInView() {
    const messagesContainer = document.getElementById('messagesContainer');
    if (!messagesContainer) return false;
    
    const rect = messagesContainer.getBoundingClientRect();
    return (
        rect.top >= 0 &&
        rect.left >= 0 &&
        rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
        rect.right <= (window.innerWidth || document.documentElement.clientWidth)
    );
}

// ğŸ†• Function: Handle visibility changes - SAXDA
function handleVisibilityChange() {
    if (!document.hidden && isChatInView()) {
        // Mark as read when tab becomes visible and chat is in view
        markMessagesAsRead();
    }
}

// ğŸ†• Initialize read receipts system - SAXDA
function initializeReadReceipts() {
    // Mark as read initially
    markMessagesAsRead();
    
    // Fetch read status every 5 seconds
    readReceiptsInterval = setInterval(fetchReadStatus, 5000);
    
    // Mark as read when scrolling to bottom
    const messagesContainer = document.getElementById('messagesContainer');
    if (messagesContainer) {
        messagesContainer.addEventListener('scroll', () => {
            const isAtBottom = messagesContainer.scrollHeight - messagesContainer.scrollTop <= messagesContainer.clientHeight + 100;
            if (isAtBottom) {
                markMessagesAsRead();
            }
        });
    }
    
    // Mark as read when receiving new messages
    const originalAddMessage = window.addMessageToContainer;
    window.addMessageToContainer = function(message) {
        if (originalAddMessage) {
            originalAddMessage(message);
        }
        if (message.senderId !== myUserId) {
            markMessagesAsRead();
        }
    };
    
    // Handle tab visibility changes
    document.addEventListener('visibilitychange', handleVisibilityChange);
    
    // Handle window focus
    window.addEventListener('focus', () => {
        if (isChatInView()) {
            markMessagesAsRead();
        }
    });
}

// =========================================================
//           MESSAGE MANAGEMENT SYSTEM - CLIENT (SAXDA)
// =========================================================

// ğŸ†• Function: Show delete options menu - SAXDA
function showDeleteMenu(messageId, messageElement, isMyMessage) {
    // Remove any existing delete menu
    hideDeleteMenu();
    
    const deleteMenu = document.createElement('div');
    deleteMenu.className = 'delete-menu';
    deleteMenu.innerHTML = `
        <div class="delete-options">
            <h4>Tirtir Fariinta</h4>
            ${isMyMessage ? `
                <button class="delete-option" onclick="deleteMessage('${messageId}', 'only_me')">
                    ğŸ—‘ï¸ Kaliya Aniga (Qofka kale wuu arki doonaa)
                </button>
                <button class="delete-option" onclick="deleteMessage('${messageId}', 'everyone')">
                    ğŸ—‘ï¸ Dhammaan (Qofka kale ma arki doono)
                </button>
            ` : `
                <button class="delete-option" onclick="deleteMessage('${messageId}', 'this_message')">
                    ğŸ—‘ï¸ Tirtir Fariintan (Kaliya aniga)
                </button>
            `}
            <button class="delete-cancel" onclick="hideDeleteMenu()">âŒ Jooji</button>
        </div>
    `;
    
    document.body.appendChild(deleteMenu);
    
    // Position the menu properly
    const rect = messageElement.getBoundingClientRect();
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    
    deleteMenu.style.position = 'absolute';
    deleteMenu.style.top = `${rect.top + scrollTop}px`;
    deleteMenu.style.left = `${rect.left + scrollLeft}px`;
    deleteMenu.style.zIndex = '1000';
    
    // Close menu when clicking outside
    setTimeout(() => {
        document.addEventListener('click', hideDeleteMenuOnClick, true);
    }, 100);
}

// ğŸ†• Function: Hide delete menu - SAXDA
function hideDeleteMenu() {
    const existingMenu = document.querySelector('.delete-menu');
    if (existingMenu) {
        existingMenu.remove();
    }
    document.removeEventListener('click', hideDeleteMenuOnClick, true);
}

// ğŸ†• Function: Hide delete menu on click - SAXDA
function hideDeleteMenuOnClick(e) {
    if (!e.target.closest('.delete-menu') && !e.target.closest('.message-actions')) {
        hideDeleteMenu();
    }
}

// ğŸ†• Function: Delete message - SAXDA
async function deleteMessage(messageId, deleteMode) {
    try {
        const response = await fetch('/api/chat/delete-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messageId: messageId,
                deleteMode: deleteMode
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update UI based on delete mode
            const messageElement = document.getElementById(`msg-${messageId}`);
            if (messageElement) {
                if (deleteMode === 'everyone') {
                    // Remove message completely
                    messageElement.remove();
                } else {
                    // Show deleted message
                    const messageContent = messageElement.querySelector('.message-content');
                    if (messageContent) {
                        messageContent.innerHTML = `
                            <div class="deleted-message">
                                <span class="deleted-icon">ğŸ—‘ï¸</span>
                                <span class="deleted-text">
                                    ${deleteMode === 'only_me' ? 'Fariintaad ayaad tirtirtay' : 'Fariintan waad tirtirtay'}
                                </span>
                            </div>
                        `;
                        messageContent.classList.add('deleted');
                    }
                }
            }
            
            showTerminalAlert(`âœ… ${data.message}`, 'success');
        } else {
            showTerminalAlert(`âŒ ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('Khalad delete-message:', error);
        showTerminalAlert('âŒ Khalad tirtirida fariinta', 'error');
    } finally {
        hideDeleteMenu();
    }
}

// ğŸ†• Function: Check message status (read/delivered) - SAXDA
async function checkMessageStatus(messageId) {
    try {
        const response = await fetch(`/api/chat/message-status/${messageId}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.status) {
                updateMessageStatusUI(messageId, data.status);
            }
        }
    } catch (error) {
        console.error('Khalad message-status:', error);
    }
}

// ğŸ†• Function: Update message status in UI - SAXDA
function updateMessageStatusUI(messageId, status) {
    const messageElement = document.getElementById(`msg-${messageId}`);
    if (!messageElement) return;
    
    let statusElement = messageElement.querySelector('.message-status');
    
    if (!statusElement) {
        statusElement = document.createElement('div');
        statusElement.className = 'message-status';
        const messageContent = messageElement.querySelector('.message-content');
        if (messageContent) {
            messageContent.appendChild(statusElement);
        }
    }
    
    if (status.isDeleted) {
        statusElement.innerHTML = '<span class="status-deleted">ğŸ—‘ï¸ La tirtiray</span>';
    } else if (status.readBy && status.readBy.includes(partnerId)) {
        // Message has been read by partner
        statusElement.innerHTML = `
            <span class="status-read">ğŸŸ¢ La Aqriyay</span>
            ${status.timestamp ? `
                <span class="status-time">
                    ${new Date(status.timestamp).toLocaleTimeString('so-SO', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    })}
                </span>
            ` : ''}
        `;
    } else if (status.delivered) {
        // Message delivered but not read
        statusElement.innerHTML = '<span class="status-delivered">ğŸŸ¡ La Gaarsiiyay</span>';
    } else {
        // Message sent but not delivered
        statusElement.innerHTML = '<span class="status-sent">âš« La Diray</span>';
    }
}

// ğŸ†• Function: Add message actions (long press/right click) - SAXDA
function addMessageActions(messageElement, messageId, isMyMessage) {
    // Add actions button
    const actionsButton = document.createElement('button');
    actionsButton.className = 'message-actions';
    actionsButton.innerHTML = 'â‹¯';
    actionsButton.title = 'Ficilada fariinta';
    actionsButton.onclick = (e) => {
        e.stopPropagation();
        showDeleteMenu(messageId, messageElement, isMyMessage);
    };
    
    const messageContent = messageElement.querySelector('.message-content');
    if (messageContent) {
        messageContent.appendChild(actionsButton);
    }
    
    // Add long press for mobile
    let pressTimer;
    messageElement.addEventListener('touchstart', (e) => {
        pressTimer = setTimeout(() => {
            showDeleteMenu(messageId, messageElement, isMyMessage);
        }, 500);
    });
    
    messageElement.addEventListener('touchend', () => {
        clearTimeout(pressTimer);
    });
    
    messageElement.addEventListener('touchmove', () => {
        clearTimeout(pressTimer);
    });
    
    // Add right click for desktop
    messageElement.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        showDeleteMenu(messageId, messageElement, isMyMessage);
    });
}

// ğŸ†• Update the addMessageToContainer function - SAXDA
function enhancedAddMessageToContainer(message) {
    // Call original function if it exists
    if (window.originalAddMessageToContainer) {
        window.originalAddMessageToContainer(message);
    }
    
    const messageElement = document.getElementById(`msg-${message.id}`);
    const isMyMessage = message.senderId === myUserId;
    
    if (messageElement) {
        // Add message actions
        addMessageActions(messageElement, message.id, isMyMessage);
        
        // Check message status for my messages
        if (isMyMessage) {
            checkMessageStatus(message.id);
        }
        
        // Check if message is deleted for current user
        if (message.deletedFor && message.deletedFor.includes(myUserId)) {
            const messageContent = messageElement.querySelector('.message-content');
            if (messageContent) {
                messageContent.innerHTML = `
                    <div class="deleted-message">
                        <span class="deleted-icon">ğŸ—‘ï¸</span>
                        <span class="deleted-text">
                            ${message.senderId === myUserId ? 
                              'Fariintaad ayaad tirtirtay' : 
                              'Fariintan waa la tirtiray'}
                        </span>
                    </div>
                `;
                messageContent.classList.add('deleted');
            }
        }
    }
}

// ğŸ†• Initialize message status polling - SAXDA
function initializeMessageStatusPolling() {
    // Check status for all my messages every 10 seconds
    setInterval(() => {
        document.querySelectorAll('.message-box.my-message').forEach(messageBox => {
            const messageId = messageBox.id.replace('msg-', '');
            checkMessageStatus(messageId);
        });
    }, 10000);
}

// =========================================================
//           INITIALIZATION - SAXDA
// =========================================================

// ğŸ†• Update DOMContentLoaded with proper initialization
document.addEventListener('DOMContentLoaded', () => {
    // ... existing code ...
    
    // Store original function before overriding
    window.originalAddMessageToContainer = window.addMessageToContainer;
    
    // Override with enhanced function
    window.addMessageToContainer = enhancedAddMessageToContainer;
    
    // Initialize systems after user info is loaded
    setTimeout(() => {
        if (myUserId && partnerId) {
            initializeReadReceipts();
            initializeMessageStatusPolling();
        }
    }, 2000);
    
    // ... existing code ...
});

// ğŸ†• Clean up intervals - SAXDA
window.addEventListener('beforeunload', () => {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    if (readReceiptsInterval) {
        clearInterval(readReceiptsInterval);
    }
});

// ğŸ†• Utility function for showing alerts - SAXDA
function showTerminalAlert(message, type = 'info') {
    // Create alert element
    const alert = document.createElement('div');
    alert.className = `terminal-alert ${type}`;
    alert.textContent = message;
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? 'rgba(255,0,0,0.9)' : 'rgba(0,255,0,0.9)'};
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 10000;
        font-family: 'Courier New', monospace;
        box-shadow: 0 0 20px rgba(0,255,0,0.5);
    `;
    
    document.body.appendChild(alert);
    
    // Remove after 3 seconds
    setTimeout(() => {
        if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
        }
    }, 3000);
}


    </script>
</body>
</html>



<script>
    // =========================================================
//           ENHANCED MESSAGE LOADING - SAXDA
// =========================================================

// ğŸ†• Function: Fetch messages using enhanced API - SAXDA
async function fetchMessages(isInitialLoad) {
    try {
        const url = `/api/chat/enhanced-history/${partnerId}`;
        console.log(`ğŸ”„ Fetching messages from: ${url}`);
        
        const response = await fetch(url);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`ğŸ“¨ API Response:`, data);
        
        if (data.success) {
            const messagesContainer = document.getElementById('messagesContainer');
            const messages = data.messages || [];
            
            console.log(`ğŸ“¨ Processing ${messages.length} messages`);
            
            // Clear container only on initial load
            if (isInitialLoad || messagesContainer.innerHTML.includes("Fadlan sug...") || messagesContainer.innerHTML.includes("Weli ma jiro")) {
                messagesContainer.innerHTML = ''; 
            }
            
            if (messages.length > 0) {
                // Process each message
                messages.forEach(msg => {
                    if (!document.getElementById(`msg-${msg.id}`)) {
                        console.log(`â• Adding new message: ${msg.id}`);
                        addMessageToContainer(msg);
                    }
                });
                
                // Update last message ID for polling
                if (messages.length > 0) {
                    lastMessageId = messages[messages.length - 1].id;
                }
                
                // Scroll to bottom on initial load or new messages
                if (isInitialLoad) {
                    scrollToBottom();
                }
                
            } else if (isInitialLoad) {
                messagesContainer.innerHTML = '<p style="text-align: center; color: #888;">Weli ma jiro wax sheeko ah. Bilow Sheekada!</p>';
            }
            
            console.log(`âœ… Successfully processed ${messages.length} messages`);
            
        } else {
            console.error('âŒ API error:', data.message);
            showTerminalAlert(`âŒ ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('âŒ Khalad soo dejinta fariimaha:', error);
        showTerminalAlert('âŒ Khalad soo dejinta fariimaha', 'error');
    }
}

// ğŸ†• Function: Enhanced addMessageToContainer - SAXDA
function addMessageToContainer(message) {
    const container = document.getElementById('messagesContainer');
    const isMyMessage = message.senderId === myUserId;
    
    // Skip if message is deleted for current user
    if (message.deletedFor && message.deletedFor.includes(myUserId)) {
        console.log(`ğŸš« Skipping deleted message: ${message.id}`);
        return;
    }
    
    const senderImage = isMyMessage ? 
                        myProfileImage : 
                        (document.getElementById('partnerImage')?.src || '/profiles/default.png');

    const senderUsername = isMyMessage ? myUsername : partnerName;
    
    const div = document.createElement('div');
    div.className = `message-box ${isMyMessage ? 'my-message' : 'partner-message'}`;
    div.id = `msg-${message.id}`;

    const time = new Date(message.timestamp).toLocaleTimeString('so-SO', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });
    
    let mediaContent = '';
    if (message.mediaPath && !message.deletedFor?.includes(myUserId)) {
        const mediaUrl = message.mediaPath;
        const mediaType = message.mediaType || 'image';
        
        if (mediaType === 'image') {
            mediaContent = `<img src="${mediaUrl}" alt="Sawir la soo diray" class="message-media" loading="lazy" onclick="openMedia('${mediaUrl}')">`;
        } else if (mediaType === 'video') {
            mediaContent = `<video controls src="${mediaUrl}" class="message-media" onclick="openMedia('${mediaUrl}')"></video>`;
        } else if (mediaType === 'audio') {
            mediaContent = `<audio controls src="${mediaUrl}" class="message-media"></audio>`;
        } else {
            mediaContent = `<a href="${mediaUrl}" target="_blank" class="message-media">File: ${message.mediaPath.split('/').pop()}</a>`;
        }
    }
    
    const messageTextContent = message.text && !message.deletedFor?.includes(myUserId) ? 
        `<p class="message-text">${escapeHtml(message.text)}</p>` : '';

    // Mobile: hide sender name to save space
    const showSender = !isMobile;
    
    div.innerHTML = `
        <img src="${senderImage}" alt="${senderUsername}" class="user-message-image" onerror="this.src='/profiles/default.png'">
        <div class="message-content">
            <div class="message-header" style="${!showSender ? 'display: none;' : ''}">
                <span class="message-sender">${escapeHtml(senderUsername)}</span>
                <span>${time}</span>
            </div>
            ${!showSender ? `<div class="message-time-mobile">${time}</div>` : ''}
            ${messageTextContent}
            ${mediaContent}
        </div>
    `;
    
    container.appendChild(div);
    
    // Add message actions and status
    addMessageActions(div, message.id, isMyMessage);
    
    if (isMyMessage) {
        checkMessageStatus(message.id);
    }
    
    console.log(`âœ… Added message to container: ${message.id}`);
}

// ğŸ†• Function: Enhanced delete message - SAXDA
async function deleteMessage(messageId, deleteMode) {
    console.log(`ğŸ—‘ï¸ Deleting message ${messageId} with mode: ${deleteMode}`);
    
    try {
        const response = await fetch('/api/chat/delete-message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                messageId: messageId,
                deleteMode: deleteMode
            })
        });
        
        const data = await response.json();
        console.log(`ğŸ—‘ï¸ Delete API response:`, data);
        
        if (data.success) {
            // Update UI based on delete mode
            const messageElement = document.getElementById(`msg-${messageId}`);
            
            if (messageElement) {
                if (deleteMode === 'everyone') {
                    // Remove message completely from UI
                    messageElement.remove();
                    console.log(`âœ… Removed message ${messageId} from UI (everyone delete)`);
                } else {
                    // Show deleted message indicator
                    const messageContent = messageElement.querySelector('.message-content');
                    if (messageContent) {
                        messageContent.innerHTML = `
                            <div class="deleted-message">
                                <span class="deleted-icon">ğŸ—‘ï¸</span>
                                <span class="deleted-text">
                                    ${deleteMode === 'only_me' ? 'Fariintaad ayaad tirtirtay' : 'Fariintan waad tirtirtay'}
                                </span>
                            </div>
                        `;
                        messageContent.classList.add('deleted');
                        console.log(`âœ… Marked message ${messageId} as deleted in UI`);
                    }
                }
            }
            
            showTerminalAlert(`âœ… ${data.message}`, 'success');
            
            // Refresh messages to ensure consistency
            setTimeout(() => {
                fetchMessages(false);
            }, 1000);
            
        } else {
            console.error(`âŒ Delete failed: ${data.message}`);
            showTerminalAlert(`âŒ ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('âŒ Khalad delete-message:', error);
        showTerminalAlert('âŒ Khalad tirtirida fariinta', 'error');
    } finally {
        hideDeleteMenu();
    }
}
</script>